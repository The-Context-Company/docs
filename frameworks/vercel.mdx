---
title: "Vercel AI SDK"
description: "Observability for Vercel AI SDK in 10 lines of code"
---

## Setup

### Set TCC environment variables

<Tip>Our SDKs default to using the `TCC_API_KEY` environment variable.</Tip>

```typescript .env.local
TCC_API_KEY = "your-api-key";
```

### Next.js API Routes

If your API calls are directly made from your Next.js API routes, you can use the `registerOTelTCC` function to instrument your calls.

#### Step 1: Install dependencies

<CodeGroup>

```Title pnpm
pnpm add @contextcompany/otel @vercel/otel @opentelemetry/api
```

```Title npm
npm i @contextcompany/otel @vercel/otel @opentelemetry/api
```

</CodeGroup>

#### Step 2: Add instrumentation to Next.js

If you haven't already, add an `instrumentation.[js|ts]` file to your project, under the `app` directory. See the [Next.js Instrumentation guide](https://nextjs.org/docs/app/guides/instrumentation) for more information on instrumenting your Next.js application.

Call the `registerOTelTCC` function and provide your API key. This allows your app to export any AI SDK related traces to The Context Company.

```typescript instrumentation.ts
import { registerOTelTCC } from "@contextcompany/otel/nextjs";

export function register() {
  if (process.env.NEXT_RUNTIME === "nodejs") registerOTelTCC();
}
```

Alternatively, you can directly import `TCCSpanProcessor` for use with the `registerOTel` function from `@vercel/otel`. This is essentially the same as using `registerOTelTCC`, but allows you to pass in additional span processors.

<Expandable title="instrumentation with TCCSpanProcessor">

```typescript instrumentation.ts
import { TCCSpanProcessor } from "@contextcompany/otel";
import { registerOTel } from "@vercel/otel";

export function register() {
  if (process.env.NEXT_RUNTIME === "nodejs")
    registerOTel({
      spanProcessors: [new TCCSpanProcessor()],
    });
}
```

</Expandable>

#### Step 3: Enable telemetry for AI SDK calls

As of AI SDK v5, telemetry is experimental and requires the `experimental_telemetry` flag to be set to `true`. Ensure you set this flag to `true` for all AI SDK calls.

<CodeGroup>

```typescript generateText
import { generateText } from "ai";

const result = generateText({
  // ...
  experimental_telemetry: { isEnabled: true }, // required
});
```

```typescript streamText
import { streamText } from "ai";

const result = streamText({
  // ...
  experimental_telemetry: { isEnabled: true }, // required
});
```

</CodeGroup>

### Node.js

If you're using a Node.js framework (e.g. Express, Fastify, etc.), you can configure the NodeSDK directly with the TCCSpanProcessor.

#### Step 1: Install dependencies

<CodeGroup>

```Title pnpm
pnpm add @contextcompany/otel @opentelemetry/sdk-node @opentelemetry/api
```

```Title npm
npm i @contextcompany/otel @opentelemetry/sdk-node @opentelemetry/api
```

</CodeGroup>

#### Step 2: Add TCCSpanProcessor to NodeSDK

```typescript tcc.ts
import { TCCSpanProcessor } from "@contextcompany/otel";
import { NodeSDK } from "@opentelemetry/sdk-node";

export const tcc = new NodeSDK({
  spanProcessors: [new TCCSpanProcessor()],
});
```

#### Step 3: Start the OpenTelemetry NodeSDK

Add the TCCSpanProcessor to the NodeSDK and start listening for traces with `.start()`.

<CodeGroup>

```typescript Basic example
import { generateText } from "ai";
import { tcc } from "./tcc";

// Start listening for traces
tcc.start();

async function main() {
  const result = await generateText({
    // ...
    experimental_telemetry: { isEnabled: true }, // required
  });
}
```

```typescript Express example
import { streamText } from "ai";
import express, { Request, Response } from "express";
import { tcc } from "./tcc";

const app = express();

// Start listening for traces
tcc.start();

app.post("/", async (req: Request, res: Response) => {
  const result = streamText({
    // ...
    experimental_telemetry: { isEnabled: true }, // required
  });
  result.pipeUIMessageStreamToResponse(res);
});

app.listen(8080, () => {
  console.log(`Server listening on port ${8080}`);
});
```

</CodeGroup>

## Usage

### Debug mode

You can enable debug mode, which will log any spans that are created and exported.

<CodeGroup>

```typescript Next.js
import { registerOTelTCC } from "@contextcompany/otel/nextjs";

export function register() {
  if (process.env.NEXT_RUNTIME === "nodejs") {
    registerOTelTCC({ debug: true });
  }
}
```

```typescript Node.js
import { TCCSpanProcessor } from "@contextcompany/otel";
import { NodeSDK } from "@opentelemetry/sdk-node";

export const tcc = new NodeSDK({
  spanProcessors: [new TCCSpanProcessor({ debug: true })],
});
```

</CodeGroup>

### Adding custom metadata

Custom metadata allows you to add additional properties to your [agent runs](/concepts#agent-runs).

This is particularly useful for tying agent runs to your own specific business logic, letting you filter and analyze agent runs by user, organization, feature, or some other dimension.

Custom metadata must be passed as a key-value pair to the `metadata` object.

```typescript route.ts
import { openai } from "@ai-sdk/openai";
import { generateText } from "ai";

const { text } = await generateText({
  // ...
  experimental_telemetry: {
    isEnabled: true,
    metadata: {
      // e.g. tag this agent run with a user id
      userId: "4a6b111c-b53a-4d00-a877-67185022ab9e",
    },
  },
});
```

Agent runs are automatically indexed by your custom metadata fields and can be filtered directly in the dashboard.

### Adding user feedback

User feedback allows you to collect score (thumbs up & thumbs down) and text feedback (up to 2000 characters) from end users on your [agent runs](/concepts#agent-runs).

This is useful for tracking user satisfaction, identifying problematic responses, and filtering agent runs in the dashboard to focus on positive or negative feedback.

#### Step 1: Generate and pass a run ID

```typescript route.ts
import { generateText } from "ai";
import { randomUUID } from "crypto";

// Generate a unique run ID (must be a UUID) before your agent execution
const runId = randomUUID();

const { text } = await generateText({
  // ...
  experimental_telemetry: {
    isEnabled: true,
    metadata: {
      "tcc.run_id": runId, // Pass the run ID in metadata
    },
  },
});

// Return the runId to your client
return { text, runId };
```

#### Step 2: Submit feedback from your client

Store the `runId` on your client, then when the user provides feedback, submit it using the `submitFeedback` function.

Both `score` and `text` are optional, but you must provide at least one:

```typescript feedback-route.ts
import { submitFeedback } from "@contextcompany/otel";

// Submit both score and text feedback:
await submitFeedback({
  runId: runId, // The run ID from your agent execution
  score: "thumbs_up", // Optional: "thumbs_up" or "thumbs_down"
  text: "This was a helpful response!", // Optional: up to 2000 characters
});
```

Agent runs with feedback can be filtered in the dashboard using the feedback filter.

### Tracking Agent Sessions

[Agent sessions](/concepts#agent-sessions) represents multiple agent runs that are grouped together. The most common use case is tracking entire conversations between a human user and an AI agent in chatbot interfaces.

Agent sessions can be tracked by setting a `tcc.sessionId` key under metadata.

```typescript route.ts
import { generateText } from "ai";

const { text } = await generateText({
  // ...
  experimental_telemetry: {
    isEnabled: true,
    metadata: {
      // use tcc.sessionId to track agent sessions
      "tcc.sessionId": "some-session-id",
    },
  },
});
```

The value of `tcc.sessionId` should be a unique identifier for the agent session. This can be any string, but it's generally recommended to use a UUID.

Agent sessions are automatically indexed and can be filtered directly in the dashboard.

## Examples

See our [examples repository](https://github.com/The-Context-Company/examples) for more detailed usage examples.

Examples currently include:

- [Express (ESM)](https://github.com/The-Context-Company/examples/tree/main/express/esm)
- [Express (CJS)](https://github.com/The-Context-Company/examples/tree/main/express/cjs)
